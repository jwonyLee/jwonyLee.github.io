---
layout: post
title: "[XCTest] ë¹„ë™ê¸° ë©”ì„œë“œ í…ŒìŠ¤íŠ¸í•˜ê¸°"
subtitle:
categories: XCTest
tags: [í…ŒìŠ¤íŠ¸, ë¹„ë™ê¸°, Swift, iOS, UnitTest, XCTest]
published: true
---

> ì´ ê¸€ì—ì„œëŠ” ìœ ë‹› í…ŒìŠ¤íŠ¸í•˜ëŠ” ë²•ì€ ë‹¤ë£¨ì§€ ì•Šê³ , ë¹„ë™ê¸° ë©”ì„œë“œë¥¼ ì–´ë–»ê²Œ í…ŒìŠ¤íŠ¸í•˜ëŠ”ì§€ë§Œ ë‹¤ë£¬ë‹¤. í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•  ë•Œ ìœ ë‹› í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•˜ì§€ ì•Šì•˜ë‹¤ë©´ [ì´ ê¸€](https://jwonylee.tistory.com/entry/XCode-Swift-Command-Line-Tool-í”„ë¡œì íŠ¸ì—ì„œ-ìœ ë‹›-í…ŒìŠ¤íŠ¸-í•˜ê¸°)ì„ ì°¸ê³ í•´ì„œ ì¶”ê°€í•œë‹¤.

ì›¹ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¨ë‹¤ê±°ë‚˜, ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë•Œì— ë³´í†µ ë¹„ë™ê¸°ë¡œ ë©”ì„œë“œë¥¼ ë§Œë“¤ê²Œ ëœë‹¤. ì´ë ‡ê²Œ ë§Œë“  ë¹„ë™ê¸° ë©”ì„œë“œë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì.

`create(_:completion:)`ëŠ” Core Dataì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë©”ì„œë“œë‹¤. completion ë¸”ë¡ì„ ì´ìš©í•´ ì„±ê³µ ì—¬ë¶€ì™€ ì—ëŸ¬ë¥¼ í•¨ê»˜ ë°˜í™˜í•œë‹¤. `NSManagedObjectContext.perform(_:)`ì€ ë¹„ë™ê¸°ë¡œ ë™ì‘í•œë‹¤.
```swift
func create(_ newPost: Post, completion: @escaping (Result<Bool, Error>) -> Void) {
    let context: NSManagedObjectContext = coreDataStack.mainContext
    context.perform {
        do {
            let post: PostEntity = newPost.toEntity(in: context)
            try context.save()
            completion(.success(true))
        } catch {
            completion(.failure(.failedCreate))
        }
    }
}
```

ì´ˆê¸° í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í–ˆì—ˆë‹¤.

```swift
func test_Postë¥¼_í•˜ë‚˜_ë§Œë“¤_ìˆ˜_ìˆë‹¤() {
    // given: í•„ìš”í•œ ëª¨ë“  ê°’ ì„¤ì •
    let repository: Repository = Repository()
    let newPost: Post = Post(title: "í…ŒìŠ¤íŠ¸ í¬ìŠ¤íŠ¸")

    // when: í…ŒìŠ¤íŠ¸ ì¤‘ì¸ ì½”ë“œ ì‹¤í–‰
    repository.create(newPost) { result in
        switch result {
        case .success(_):
            // then: ì˜ˆìƒí•œ ê²°ê³¼ í™•ì¸
            repository.get(withIdentifier: newPost.identifier) { getResult in
                switch getResult {
                case .success(let postEntity):
                    XCTAssertEqual(postEntity.title ?? "", newPost.title)
                case .failure(let error):
                    XCTFail(error.localizedDescription)
                }
            }
        case .failure(let error):
            XCTFail(error.localizedDescription)
        }
    }
}
```

ì°¸ê³ ë¡œ í…ŒìŠ¤íŠ¸ ì½”ë“œì— ìˆëŠ” `get(withIdentifier:completion:)` ë„ ë¹„ë™ê¸° ë©”ì„œë“œë‹¤.

ì²˜ìŒì— ì‘ì„±í•˜ê³ , í•­ìƒ ì„±ê³µí•˜ê¸¸ë˜ ë‚´ê°€ ì œëŒ€ë¡œ ì‘ì„±í•œ ì¤„ ì•Œê³  ìˆì—ˆë‹¤. ì´ë ‡ê²Œ ì‘ì„±í•˜ê³  ì½”ë“œ ë¦¬ë·°ë¥¼ ë°›ê³  ë‚˜ì„œ ì•Œê²Œ ëœ ì‚¬ì‹¤ì´ ìˆëŠ”ë°, <mark>í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ë¹„ë™ê¸°ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì§€ ì•ŠëŠ”ë‹¤.</mark> ê·¸ë˜ì„œ í•­ìƒ ì„±ê³µí–ˆë˜ ê±°ì˜€ë‹¤. ğŸ˜‚

í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ë¹„ë™ê¸° ë©”ì„œë“œì˜ ê²°ê³¼ê°€ ë°˜í™˜ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì§€ ì•ŠëŠ”ë‹¤ë©´, ê¸°ë‹¤ë¦¬ê²Œ ë§Œë“¤ì.

```swift
extension XCTestCase {
    func timeout(_ timeout: TimeInterval, completion: (XCTestExpectation) -> Void) {
        let exp: XCTestExpectation = expectation(description: "Timeout: \(timeout) seconds")
        completion(exp)

        waitForExpectations(timeout: timeout) { error in
            guard let error = error else { return }
            XCTFail("Timeout error: \(error)")
        }
    }
}
```

`XCTestCase`ì˜ extensionìœ¼ë¡œ ë§Œë“¤ì–´ì„œ ë¹„ë™ê¸° ë©”ì„œë“œë¥¼ í…ŒìŠ¤íŠ¸í•  ë•Œ í˜¸ì¶œí•´ì„œ ì‚¬ìš©í•œë‹¤. ì´ ì½”ë“œëŠ” ê°™ì´ í”„ë¡œì íŠ¸ í•˜ì‹œëŠ” ë¶„ì´ ì•Œë ¤ì£¼ì‹  ê±´ë° ë¬´í•œí•œ ê°ì‚¬ì˜ ë§ì”€ì„ ì „í•©ë‹ˆë‹¤... ğŸ™

```swift
let exp: XCTestExpectation = expectation(description: "Timeout: \(timeout) seconds")
```

> Use this method to create XCTestExpectation instances that can be fulfilled when asynchronous tasks in your tests complete.

> ì´ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ì˜ ë¹„ë™ê¸° ì‘ì—…ì´ ì™„ë£Œë  ë•Œ ì¶©ì¡±ë  ìˆ˜ ìˆëŠ” XCTestExpectation ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“ ë‹¤.

`description`ì— ë“¤ì–´ê°€ëŠ” ë¬¸ìì—´ì€ ì‹œê°„ ì´ˆê³¼í•˜ë©´ ì¶œë ¥ë  ë¬¸ìì—´ì´ë‹¤.

```swift
waitForExpectations(timeout: timeout) { error in
    guard let error = error else { return }
    XCTFail("Timeout error: \(error)")
}
```

`waitForExpectations(timeout:handler:)`ëŠ” í…ŒìŠ¤íŠ¸ê°€ ëª¨ë“  ê¸°ëŒ€ì¹˜ë¥¼ ì¶©ì¡±í•˜ê±°ë‚˜ ì‹œê°„ì´ ì´ˆê³¼í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤. ì—¬ê¸°ì„œ ë§í•˜ëŠ” ê¸°ëŒ€ì¹˜ ì¶©ì¡±ì´ë€ `XCTestExpectation.fulfill()` ë©”ì„œë“œ í˜¸ì¶œì„ ëœ»í•œë‹¤. ìœ„ì˜ ì½”ë“œë¥¼ ë‹¤ì‹œ ë³´ë©´ `completion(exp)` ìœ¼ë¡œ ì™¸ë¶€ì— ë°˜í™˜í•˜ëŠ”ë° ë¹„ë™ê¸° ë©”ì„œë“œë¥¼ ë‹¤ ê¸°ë‹¤ë¦¬ê³  ë‚˜ì„œ ê¸°ëŒ€ì¹˜ ì¶©ì¡±í–ˆë‹¤ê³  í˜¸ì¶œí•˜ê¸° ìœ„í•¨ì´ë‹¤.

ì´ë ‡ê²Œ ë§Œë“  `timeout(_:completion:)` ë©”ì„œë“œë¥¼ ë¹„ë™ê¸° ë©”ì„œë“œ í…ŒìŠ¤íŠ¸í•  ë•Œ ì‚¬ìš©í•˜ë©´ ë˜ëŠ”ë° í•­ìƒ ì„±ê³µí–ˆë˜ ë§í•œ ì½”ë“œë¥¼ `timeout(_:completion:)` ë©”ì„œë“œë¥¼ ì´ìš©í•´ì„œ ìˆ˜ì •í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

```swift
func test_Postë¥¼_í•˜ë‚˜_ë§Œë“¤_ìˆ˜_ìˆë‹¤() {
    // given: í•„ìš”í•œ ëª¨ë“  ê°’ ì„¤ì •
    let repository: Repository = Repository()
    let newPost: Post = Post(title: "í…ŒìŠ¤íŠ¸ í¬ìŠ¤íŠ¸")

    // when: í…ŒìŠ¤íŠ¸ ì¤‘ì¸ ì½”ë“œ ì‹¤í–‰
    timeout(5) { exp in
        repository.create(newPost) { result in
            switch result {
            case .success(_):
                // then: ì˜ˆìƒí•œ ê²°ê³¼ í™•ì¸
                repository.get(withIdentifier: newPost.identifier) { getResult in
                    exp.fulfill() // â† ì´ ìœ„ì¹˜!
                    switch getResult {
                    case .success(let postEntity):
                        XCTAssertEqual(postEntity.title ?? "", newPost.title)
                    case .failure(let error):
                        XCTFail(error.localizedDescription)
                    }
                }
            case .failure(let error):
                XCTFail(error.localizedDescription)
            }
        }
        // exp.fulfill() ì—¬ê¸°ì„œ í˜¸ì¶œí•˜ë©´ âŒ
    }
}
```

ì—¬ê¸°ì„œ ì£¼ì˜í•´ì•¼ í•  ì ì€, `fulfill()` ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ì´ `create` í´ë¡œì €ê°€ ëë‚œ í›„ì— í•˜ë©´ ì•ˆ ë˜ê³  í´ë¡œì € ë‚´ë¶€ì—ì„œ í˜¸ì¶œí•´ì•¼ í•œë‹¤. ì™œëƒí•˜ë©´, í´ë¡œì €ê°€ ëë‚˜ê³  í˜¸ì¶œí•˜ê²Œ ë˜ë©´ `create` ë©”ì„œë“œê°€ ë¹„ë™ê¸°ë¼ì„œ ëë‚˜ì§€ ì•Šì•˜ëŠ”ë° ëë‚¬ë‹¤ê³  ì²˜ë¦¬ëœë‹¤. ê²Œë‹¤ê°€ ì´ ì½”ë“œëŠ” ë¹„ë™ê¸°ë¥¼ ì´ì¤‘ìœ¼ë¡œ í˜¸ì¶œí•˜ê³  ìˆìœ¼ë‹ˆ, `create` í´ë¡œì € ë‚´ë¶€ì— ìˆëŠ” `get` í´ë¡œì € ì•ˆì—ì„œ í˜¸ì¶œí•´ì•¼ í•œë‹¤.

ë”ë¶ˆì–´ `fulfill()` í˜¸ì¶œê³¼ ê´€ê³„ì—†ì´, ì§€ì •í•œ ì‹œê°„ì„ ì´ˆê³¼í•˜ê²Œ ë˜ë©´ ìì—°ìŠ¤ë ˆ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ê²Œ ëœë‹¤.

## ì°¸ê³  ìë£Œ

- [XCTestExpectation - Apple Developer Documentation](https://developer.apple.com/documentation/xctest/xctestexpectation)
- [fulfill() - Apple Developer Documentation](https://developer.apple.com/documentation/xctest/xctestexpectation/1501027-fulfill)
- [waitForExpectations(timeout:handler:) - Apple Developer Documentation](https://developer.apple.com/documentation/xctest/xctestcase/1500748-waitforexpectations)