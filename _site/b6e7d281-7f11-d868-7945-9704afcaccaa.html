<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>📌 기존 프로젝트에서 기능을 분리해서 Swift Package로 모듈화하기
</code></pre></div></div>

<p>iOS 프로젝트에서 모듈화 하는 방식은 아래와 같다.</p>
<ul>
  <li>Swift Package 로 만들기</li>
  <li>(Dynamic/Static) Framework 로 만들기</li>
  <li>(Dynamic/Static) Library 로 만들기</li>
</ul>

<p>이 글에서는 Swift Package 로 만든다.</p>

<h2 id="패키지-생성과-기본-설정">패키지 생성과 기본 설정</h2>

<p><code class="language-plaintext highlighter-rouge">File &gt; New &gt; Package</code> 를 선택한다.</p>

<p><img src="/assets/img/create-SPM/file-new-package.png" alt="File &gt; New &gt; Package" /></p>

<p>패키지 이름과 위치를 지정해준다. 공통 모듈을 만들기 위해서 <code class="language-plaintext highlighter-rouge">Platform</code> 이라는 이름으로 지정해주었고, 위치는 기존 프로젝트로 지정해주었다. 그리고 하단에 Add to: Group: 이라는 부분에 기존 프로젝트를 선택한다.</p>

<p><img src="/assets/img/create-SPM/create-package.png" alt="create Package" /></p>

<p>Create 를 누르면 패키지가 생성이 된다. 기본으로 생성되는 구조는 다음과 같다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Platform (패키지 이름)
├── README.md
├── Package.swift
├── Sources
│   └── Platform
│       └── Platform.swift
└── Tests
    └── PlatformTests
        └── PlatformTests.swift
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Package.swift</code>는 패키지의 설정을 정의하는 파일이다. 새로운 모듈을 추가하거나, 의존성을 추가하는 등의 작업은 여기서 한다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// swift-tools-version:5.5</span>
<span class="c1">// The swift-tools-version declares the minimum version of Swift required to build this package.</span>

<span class="kd">import</span> <span class="kt">PackageDescription</span>

<span class="k">let</span> <span class="nv">package</span> <span class="o">=</span> <span class="kt">Package</span><span class="p">(</span>
    <span class="nv">name</span><span class="p">:</span> <span class="s">"Platform"</span><span class="p">,</span>
    <span class="nv">products</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">// Products define the executables and libraries a package produces, and make them visible to other packages.</span>
        <span class="o">.</span><span class="nf">library</span><span class="p">(</span>
            <span class="nv">name</span><span class="p">:</span> <span class="s">"Platform"</span><span class="p">,</span>
            <span class="nv">targets</span><span class="p">:</span> <span class="p">[</span><span class="s">"Platform"</span><span class="p">]),</span>
    <span class="p">],</span>
    <span class="nv">dependencies</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">// Dependencies declare other packages that this package depends on.</span>
        <span class="c1">// .package(url: /* package url */, from: "1.0.0"),</span>
    <span class="p">],</span>
    <span class="nv">targets</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1">// Targets are the basic building blocks of a package. A target can define a module or a test suite.</span>
        <span class="c1">// Targets can depend on other targets in this package, and on products in packages this package depends on.</span>
        <span class="o">.</span><span class="nf">target</span><span class="p">(</span>
            <span class="nv">name</span><span class="p">:</span> <span class="s">"Platform"</span><span class="p">,</span>
            <span class="nv">dependencies</span><span class="p">:</span> <span class="p">[]),</span>
        <span class="o">.</span><span class="nf">testTarget</span><span class="p">(</span>
            <span class="nv">name</span><span class="p">:</span> <span class="s">"PlatformTests"</span><span class="p">,</span>
            <span class="nv">dependencies</span><span class="p">:</span> <span class="p">[</span><span class="s">"Platform"</span><span class="p">]),</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div>

<p>가장 먼저 해줘야 하는 것은, 이 패키지의 플랫폼(not my package)을 지정해주는 것이다. 플랫폼은 이 패키지의 지원하고자 하는 플랫폼과 버전을 지정하는 것이다. 기존 프로덕트의 iOS Deployment Target 과 동일하게 설정하면 된다. 왜 이 값이 기본값으로 안 들어갔는지가 의문이다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">PackageDescription</span>

<span class="k">let</span> <span class="nv">package</span> <span class="o">=</span> <span class="kt">Package</span><span class="p">(</span>
    <span class="nv">name</span><span class="p">:</span> <span class="s">"Platform"</span><span class="p">,</span>
    <span class="nv">platforms</span><span class="p">:</span> <span class="p">[</span>
        <span class="o">.</span><span class="nf">iOS</span><span class="p">(</span><span class="o">.</span><span class="n">v12</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="nv">products</span><span class="p">:</span> <span class="p">[</span>
</code></pre></div></div>

<p>만약 이 값을 지정하지 않거나, 내가 이 패키지를 사용하는 프로젝트 버전이 더 낮다면 다음과 같은 빌드 에러가 뜬다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The package product '디펜던시 이름' requires minimum platform version 10.0 for the iOS platform, but this target supports 9.0
</code></pre></div></div>

<h2 id="모듈-추가하기">모듈 추가하기</h2>

<p><code class="language-plaintext highlighter-rouge">Network</code> 라는 모듈을 추가하고 싶다.</p>

<p>먼저 기본으로 생성된 <code class="language-plaintext highlighter-rouge">Sources/Platform</code> 과 <code class="language-plaintext highlighter-rouge">Tests/PlatformTests</code> 디렉토리를 삭제한다. 이 상태에서 빌드하면 실패하고, 에러가 뜬다.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Source files for target Platform should be located under 'Sources/Platform', or a custom sources path can be set with the 'path' property in Package.swift
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Package.swift</code> 파일에서 <code class="language-plaintext highlighter-rouge">Platform</code> 이라는 모듈과 <code class="language-plaintext highlighter-rouge">PlatformTests</code> 라는 모듈을 추가해뒀는데, 찾지 못해서 뜨는 에러다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">products</span><span class="p">:</span> <span class="p">[</span>
    <span class="o">.</span><span class="nf">library</span><span class="p">(</span>
        <span class="nv">name</span><span class="p">:</span> <span class="s">"Platform"</span><span class="p">,</span>
        <span class="nv">targets</span><span class="p">:</span> <span class="p">[</span><span class="s">"Platform"</span><span class="p">]</span>
    <span class="p">),</span>
<span class="p">],</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Platform</code> 이라고 쓰여있는 부분을 <code class="language-plaintext highlighter-rouge">Network</code>로 대체한다. <code class="language-plaintext highlighter-rouge">Network</code> 모듈 뿐만 아니라 <code class="language-plaintext highlighter-rouge">Core</code> 라는 모듈도 추가하고 싶다면? 다음과 같이 작성한다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">products</span><span class="p">:</span> <span class="p">[</span>
    <span class="o">.</span><span class="nf">library</span><span class="p">(</span>
        <span class="nv">name</span><span class="p">:</span> <span class="s">"Network"</span><span class="p">,</span>
        <span class="nv">targets</span><span class="p">:</span> <span class="p">[</span><span class="s">"Network"</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="o">.</span><span class="nf">library</span><span class="p">(</span>
        <span class="nv">name</span><span class="p">:</span> <span class="s">"Core"</span><span class="p">,</span>
        <span class="nv">targets</span><span class="p">:</span> <span class="p">[</span><span class="s">"Core"</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">],</span>
</code></pre></div></div>

<p>그런 다음 targets 항목에 Network 모듈을 추가한다. (기존에 있던 PlatformTests 타겟은 제거)</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">targets</span><span class="p">:</span> <span class="p">[</span>
    <span class="o">.</span><span class="nf">target</span><span class="p">(</span>
        <span class="nv">name</span><span class="p">:</span> <span class="s">"Network"</span><span class="p">,</span>
        <span class="nv">dependencies</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">)</span>
<span class="p">]</span>
</code></pre></div></div>

<p>이렇게 작성하면 설정은 끝이 났고, 빌드하면 역시나 경로를 찾지 못한다는 에러가 뜬다. Sources 디렉토리 내에 Network 디렉토리를 생성하면 된다.</p>

<p>만약 Network 모듈에서 외부 라이브러리를 사용하고 싶다면 어떻게 해야할까? dependencies 항목에 사용하고자 하는 외부 라이브러리를 추가하면 된다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">dependencies</span><span class="p">:</span> <span class="p">[</span>
    <span class="o">.</span><span class="nf">package</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="s">"https://github.com/ReactiveX/RxSwift.git"</span><span class="p">,</span> <span class="o">.</span><span class="nf">exact</span><span class="p">(</span><span class="s">"6.5.0"</span><span class="p">))</span>
<span class="p">],</span>
</code></pre></div></div>

<p>이렇게 디펜던시를 추가한 뒤에,</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">targets</span><span class="p">:</span> <span class="p">[</span>
    <span class="o">.</span><span class="nf">target</span><span class="p">(</span>
        <span class="nv">name</span><span class="p">:</span> <span class="s">"Network"</span><span class="p">,</span>
        <span class="nv">dependencies</span><span class="p">:</span> <span class="p">[</span><span class="s">"RxSwift"</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">]</span>
</code></pre></div></div>

<p>외부 라이브러리를 사용하는 target의 dependencies 에 해당 디펜던시 이름을 넣어준다.</p>

<hr />

<p>추가적으로 이건 내가 자주 놓치는 부분인데, Swift 에서는 주로 접근 지정자를 기본값인 <code class="language-plaintext highlighter-rouge">internal</code> 과 <code class="language-plaintext highlighter-rouge">private</code> 을 많이 쓴다. 그래서 기존 프로젝트에 있던 클래스/구조체/열거형을 모듈로 옮겨서 사용하면 <code class="language-plaintext highlighter-rouge">internal</code>에서 범위(모듈 내부만 가능)가 벗어났기 때문에 나는 분명 import 도 잘해줬는데 모듈을 찾을 수 없다고 뜬다. 모듈로 분리한 객체는 잊지말고 <code class="language-plaintext highlighter-rouge">public</code>으로 지정해주자. 이걸로 삽질 꽤나 했다. 흑흑.</p>

<p>그리고 가끔, 잘했는데도 빌드가 안된다면, Xcode 를 껐다 켜자.</p>

<h2 id="태그">태그</h2>

<p>#Swift/Pakage #iOS/PackageManager/SPM</p>
