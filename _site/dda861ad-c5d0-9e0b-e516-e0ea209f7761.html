<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>이 글은 사내에서 발표한 내용을 재구성했습니다. 잘못된 부분이 있으면 댓글로 남겨주세요.
</code></pre></div></div>

<p>WWDC22 에서 iOS 16 소개에서 Live Activity 가 발표됐다. 영상을 보는 순간 우리 회사 도메인과 잘 어울리는 API 라고 생각했고, 관련 영상이 나오기를 기다리고 있었다. 하지만 영상도 나오지 않았고, 문서도 나오지 않아서 그저 실망만 하고 있었는데, 최근에 문서가 업데이트 됐다.</p>

<h2 id="개요">개요</h2>

<p>Live Activity 는 iOS 16 부터 지원하는 API다. ActivityKit 에 있고, WidgetKit 과 ActivityKit 의 조합으로 구성한다.</p>

<p>애플에서는 이를 스포츠 게임 중계 같은 실시간 상황에서 사용할 수 있다고 소개한다.</p>

<h2 id="이-글의-목표">이 글의 목표</h2>

<p><a href="https://developer.apple.com/documentation/activitykit/displaying-live-data-on-the-lock-screen-with-live-activities">문서</a>에서는 피자 딜리버리를 예시로 들고 있다. 피자 딜리버리도 분명 좋은 예시지만, 더 익숙하게 우리 회사 도메인과 어울리게 구성해볼까 한다.</p>

<p>요금, 주행 거리, 주행 시간 으로 구성한 자전거 라이딩 기록을 보여줄 것이다.</p>

<h2 id="프로젝트-구성">프로젝트 구성</h2>

<p>본문에서 작성한 코드는 <a href="https://github.com/jwonyLee/LiveActivitiesPractice">jwonyLee/LiveActivitiesPractice</a> 에서 볼 수 있다.</p>

<h3 id="1-새로운-ios-프로젝트-생성">1. 새로운 iOS 프로젝트 생성</h3>

<blockquote>
  <p>기존 프로젝트에 적용한다면 2. Widget Extension 추가하기로 건너뛴다.</p>
</blockquote>

<p>Live Activity(= ActivityKit)은 Xcode 14 부터 사용 가능하다. 나는 Xcode 14-Beta4 로 프로젝트를 생성했다. 그 이하 버전에서도 동작하는 지는 모르겠다. (확인 필요)</p>

<p>iOS 16 부터 사용 가능하기 때문에 iOS Deployment Target 을 16 이상으로 설정하거나, 그 이하의 버전을 지원하는 프로젝트라면 <code class="language-plaintext highlighter-rouge">available</code> 구문으로 iOS 16 이상에서 동작한다고 명시해야 한다.</p>

<h3 id="2-widget-extension-추가하기">2. Widget Extension 추가하기</h3>

<p>개요에서도 설명했다시피 Live Activity 는 WidgetKit 과 ActivityKit 의 조합으로 구현한다. 프로젝트에 Widget Extension 을 추가한다.</p>

<p><img src="/assets/img/LiveActivity/File%20new%20Target.png" alt="File &gt; New &gt; Target" /></p>

<p><img src="/assets/img/LiveActivity/Choose%20a%20templete%20for%20your%20new%20target.png" alt="Choose a template for your new target:" /></p>

<p><img src="/assets/img/LiveActivity/Choose%20options%20for%20your%20new%20target.png" alt="Choose options for your new target:" /></p>

<p>Product Name 은 적절하게 지어주면 되는데, 나는 대략 <code class="language-plaintext highlighter-rouge">LiveActivitiesDashboard</code> 라는 이름으로 지정했다.</p>

<p>Live Activity 를 사용하기 위해서 Info.plist 에 <code class="language-plaintext highlighter-rouge">NSSuppoortedLiveActivities</code> 를 추가하고, YES 로 설정해야 한다.</p>

<blockquote>
  <p>Widget Target 의 Info.plist 에 추가하면 안되고, App Target 의 Info.plist 에 추가해야 한다. 그렇지 않으면 Live Activity 를 시도했을 때, <code class="language-plaintext highlighter-rouge">com.apple.ActivityKit.ActivityInput error1</code> 에러가 발생한다.</p>
</blockquote>

<h2 id="구현">구현</h2>

<h3 id="live-activity-에-사용할-모델-구현하기">Live Activity 에 사용할 모델 구현하기</h3>

<p>Live Activity 가 사용할 모델은 <code class="language-plaintext highlighter-rouge">ActivityAttributes</code> 를 채택해서 구현한다. 이 때, 동적 데이터는 ContentState 에 정의하고, 정적 데이터는 외부, 즉 Attributes 에 정의한다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">RidingAttributes</span><span class="p">:</span> <span class="kt">ActivityAttributes</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">typealias</span> <span class="kt">RidingStatus</span> <span class="o">=</span> <span class="kt">ContentState</span>

    <span class="kd">public</span> <span class="kd">struct</span> <span class="kt">ContentState</span><span class="p">:</span> <span class="kt">Codable</span><span class="p">,</span> <span class="kt">Hashable</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">fee</span><span class="p">:</span> <span class="kt">Int</span>
        <span class="k">var</span> <span class="nv">estimatedDistance</span><span class="p">:</span> <span class="kt">Double</span>
        <span class="k">var</span> <span class="nv">estimatedRidingTime</span><span class="p">:</span> <span class="kt">Date</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="잠금-화면에-표시할-ui-구현">잠금 화면에 표시할 UI 구현</h3>

<p><code class="language-plaintext highlighter-rouge">ActivityConfiguration(attributesType:)</code>로 잠금 화면에 표시할 UI 를 구성한다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">@main</span>
<span class="kd">struct</span> <span class="kt">LiveActivitiesDashboard</span><span class="p">:</span> <span class="kt">WidgetBundle</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">Widget</span> <span class="p">{</span>
        <span class="kt">RidingActivityWidget</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">RidingActivityWidget</span><span class="p">:</span> <span class="kt">Widget</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">WidgetConfiguration</span> <span class="p">{</span>
        <span class="kt">ActivityConfiguration</span><span class="p">(</span><span class="nv">attributesType</span><span class="p">:</span> <span class="kt">RidingAttributes</span><span class="o">.</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">context</span> <span class="k">in</span>
            <span class="kt">VStack</span> <span class="p">{</span>
                <span class="kt">HStack</span> <span class="p">{</span>
                    <span class="kt">VStack</span><span class="p">(</span><span class="nv">alignment</span><span class="p">:</span> <span class="o">.</span><span class="n">center</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kt">Text</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">fee</span><span class="se">)</span><span class="s"> 원"</span><span class="p">)</span>
                            <span class="o">.</span><span class="nf">font</span><span class="p">(</span><span class="o">.</span><span class="n">headline</span><span class="p">)</span>
                        <span class="kt">Text</span><span class="p">(</span><span class="s">"요금"</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="o">.</span><span class="nf">frame</span><span class="p">(</span><span class="nv">maxWidth</span><span class="p">:</span> <span class="o">.</span><span class="n">infinity</span><span class="p">)</span>

                    <span class="c1">// 생략 ...</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>만약 모델 파일과 위젯 파일의 타겟이 달라서 위젯에서 모델 타입을 찾지 못한다면? 모델 파일의 Target Member 에 위젯 타겟을 체크한다.</p>
</blockquote>

<h3 id="app-의-ui-구현">App 의 UI 구현</h3>

<p>앱의 UI 는 간단하게 Live Activity 를 시작하고 종료하는 버튼 두 개로 구성했다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kt">VStack</span> <span class="p">{</span>
        <span class="kt">Button</span><span class="p">(</span><span class="s">"Start Live Activities"</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">startLiveActivities</span><span class="p">()</span>
            <span class="nf">updateData</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>

        <span class="kt">Button</span><span class="p">(</span><span class="s">"Stop Live Activites"</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">stopLiveActivities</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="o">.</span><span class="nf">padding</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>~허접~</p>

<p>메서드를 구현해보자.</p>

<h3 id="startliveactivities"><code class="language-plaintext highlighter-rouge">startLiveActivities()</code></h3>

<p>Live Activity 는 여러개가 실행될 수 있다. 나는 하나만 실행하고 싶어서 옵셔널 프로퍼티로 갖게 해서, 중복 실행을 방지하고자 했다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">fee</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">estimatedDistance</span><span class="p">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">estimatedRidingTime</span><span class="p">:</span> <span class="kt">Date</span> <span class="o">=</span> <span class="kt">Date</span><span class="p">()</span>

<span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">ridingActivity</span><span class="p">:</span> <span class="kt">Activity</span><span class="o">&lt;</span><span class="kt">RidingAttributes</span><span class="o">&gt;</span><span class="p">?</span>

<span class="kd">private</span> <span class="kd">func</span> <span class="nf">startLiveActivities</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">ridingActivity</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="nv">ridingAttributes</span> <span class="o">=</span> <span class="kt">RidingAttributes</span><span class="p">()</span>

    <span class="k">let</span> <span class="nv">initialContentState</span> <span class="o">=</span> <span class="kt">RidingAttributes</span><span class="o">.</span><span class="kt">RidingStatus</span><span class="p">(</span>
        <span class="nv">fee</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
        <span class="nv">estimatedDistance</span><span class="p">:</span> <span class="n">estimatedDistance</span><span class="p">,</span>
        <span class="nv">estimatedRidingTime</span><span class="p">:</span> <span class="n">estimatedRidingTime</span>
    <span class="p">)</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="n">ridingActivity</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Activity</span><span class="o">&lt;</span><span class="kt">RidingAttributes</span><span class="o">&gt;.</span><span class="nf">request</span><span class="p">(</span>
            <span class="nv">attributes</span><span class="p">:</span> <span class="n">ridingAttributes</span><span class="p">,</span>
            <span class="nv">contentState</span><span class="p">:</span> <span class="n">initialContentState</span><span class="p">,</span>
            <span class="nv">pushType</span><span class="p">:</span> <span class="kc">nil</span>
        <span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Requested a riding Live Activity </span><span class="se">\(</span><span class="n">ridingActivity</span><span class="p">?</span><span class="o">.</span><span class="n">id</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span> <span class="nf">catch</span> <span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Error requesting riding Live Activity </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="updateliveactivities"><code class="language-plaintext highlighter-rouge">updateLiveActivities()</code></h3>

<p>Widget 이 timeline 매커니즘을 사용해서 데이터를 업데이트 하는 것과 달리 Live Activity 는 다른 방식으로 데이터를 갱신한다.</p>

<ol>
  <li>ActivityKit 을 이용해서 데이터를 전달한다.</li>
  <li>Remote Push Notification 을 이용해서 데이터를 갱신한다.</li>
</ol>

<p>여기서는 1번 방식을 사용했다. 시간 부족으로 Remote Push Notification 방식은 살펴보지 못했다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">@State</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">timer</span><span class="p">:</span> <span class="kt">Timer</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>

<span class="kd">private</span> <span class="kd">func</span> <span class="nf">updateData</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="kt">Timer</span><span class="o">.</span><span class="nf">scheduledTimer</span><span class="p">(</span><span class="nv">withTimeInterval</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span> <span class="nv">repeats</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
        <span class="k">self</span><span class="o">.</span><span class="n">estimatedDistance</span> <span class="o">+=</span> <span class="kt">Double</span><span class="o">.</span><span class="nf">random</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="mi">0</span><span class="o">...</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">fee</span> <span class="o">=</span> <span class="mi">400</span> <span class="o">+</span> <span class="p">(</span><span class="mi">150</span> <span class="o">*</span> <span class="kt">Int</span><span class="p">(</span><span class="n">estimatedDistance</span><span class="p">))</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">updateLiveActivities</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Timer(withDuration:block:)</code>를 이용해서 주기적으로 데이터를 갱신한다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">func</span> <span class="nf">updateLiveActivities</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">Task</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">updatedRidingStatus</span> <span class="o">=</span> <span class="kt">RidingAttributes</span><span class="o">.</span><span class="kt">RidingStatus</span><span class="p">(</span>
            <span class="nv">fee</span><span class="p">:</span> <span class="n">fee</span><span class="p">,</span>
            <span class="nv">estimatedDistance</span><span class="p">:</span> <span class="n">estimatedDistance</span><span class="p">,</span>
            <span class="nv">estimatedRidingTime</span><span class="p">:</span> <span class="n">estimatedRidingTime</span>
        <span class="p">)</span>

        <span class="k">await</span> <span class="n">ridingActivity</span><span class="p">?</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="n">updatedRidingStatus</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>갱신한 데이터는 <code class="language-plaintext highlighter-rouge">RidingStatus</code> 로 만들어서 <code class="language-plaintext highlighter-rouge">Activity&lt;Attributes&gt;.update(using:)</code> 메서드로 전달한다.</p>

<h3 id="cancleliveactivities"><code class="language-plaintext highlighter-rouge">cancleLiveActivities()</code></h3>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">func</span> <span class="nf">stopLiveActivities</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">Task</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">updatedRidingStatus</span> <span class="o">=</span> <span class="kt">RidingAttributes</span><span class="o">.</span><span class="kt">RidingStatus</span><span class="p">(</span>
            <span class="nv">fee</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nv">estimatedDistance</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nv">estimatedRidingTime</span><span class="p">:</span> <span class="kt">Date</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">do</span> <span class="p">{</span>
            <span class="k">try</span> <span class="k">await</span> <span class="n">ridingActivity</span><span class="p">?</span><span class="o">.</span><span class="nf">end</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="n">updatedRidingStatus</span><span class="p">,</span> <span class="nv">dismissalPolicy</span><span class="p">:</span> <span class="o">.</span><span class="n">immediate</span><span class="p">)</span>
            <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">invalidate</span><span class="p">()</span>
        <span class="p">}</span> <span class="nf">catch</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Error ending activity </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Activity&lt;Attributes&gt;.end(using:dismissalPolicy:)</code> 메서드를 이용해서 종료한다. 이것을 사용하면서 생소했던 부분은, 그냥 종료시키는게 아니라 초기화된 Status 를 만들어서 전달하는 것이다.</p>

<p><code class="language-plaintext highlighter-rouge">dismissalPolicy</code> 는 종료 시점을 설정한다. <code class="language-plaintext highlighter-rouge">default</code>, <code class="language-plaintext highlighter-rouge">immediate</code>, <code class="language-plaintext highlighter-rouge">after(_:)</code>가 있다.</p>

<p><code class="language-plaintext highlighter-rouge">immediate</code> 는 즉각 종료이다. <code class="language-plaintext highlighter-rouge">after(_:)</code> 는 지정한 시간이 지나면 종료한다.</p>

<p>Live Activity 는 최대 8시간까지 활성화될 수 있다. 그 이상의 시간이 지나면 시스템에서 자동으로 종료한다. 그 후에는 최대 4시간까지 잠금화면에서 남아있다. 그래서 도합 12시간까지 잠금화면에 남아있을 수 있다.</p>

<h2 id="동작">동작</h2>

<p><img src="/assets/img/LiveActivity/Play.gif" alt="동작" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Date</code> 를 timer 로 표시할 때, 정렬이 안되는 버그가 있다.</li>
  <li>생각보다 매끄럽지 않음. 약간의 딜레이가 있다.
    <ul>
      <li>짧은 주기로 계속 갱신하는 경우, 일정 시간 이후 앱이 죽는다. (1초)</li>
      <li>간혈적으로 갱신할 때, 뷰가 깨지는 경우가 있다.</li>
    </ul>
  </li>
  <li>역시 베타답게 아직 불안정한듯 하다.</li>
</ul>

<h2 id="질문">질문</h2>

<blockquote>
  <p>공유하고 나서 다른 분들께 받은 질문</p>
</blockquote>

<ul>
  <li>앱의 Life Cycle 과 연관되어 있는지
    <ul>
      <li>별도의 라이프 사이클을 가지고 있는 것 같다: 앱을 백그라운드에서 죽여도 살아 있다.</li>
    </ul>
  </li>
  <li>액티비티를 종료시킨다의 의미
    <ul>
      <li>잠금화면에서 제거한다는 뜻, 혹은.. 더 이상 사용하지 않겠다고 시스템에 알리는 것.</li>
    </ul>
  </li>
</ul>

<h2 id="참고-자료">참고 자료</h2>

<ul>
  <li><a href="https://developer.apple.com/documentation/ActivityKit">ActivityKit</a></li>
  <li><a href="https://developer.apple.com/documentation/activitykit/displaying-live-data-on-the-lock-screen-with-live-activities">Displaying live data on the Lock Screen with Live Activities</a></li>
</ul>

<h2 id="태그">태그</h2>

<p>#iOS/ActivityKit</p>
