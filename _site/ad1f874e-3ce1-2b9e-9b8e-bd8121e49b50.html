<h1 id="xctest-비동기-메서드-테스트하기">[XCTest] 비동기 메서드 테스트하기</h1>

<blockquote>
  <p>이 글에서는 유닛 테스트하는 법은 다루지 않고, 비동기 메서드를 어떻게 테스트하는지만 다룬다. 프로젝트를 생성할 때 유닛 테스트를 추가하지 않았다면 <a href="https://jwonylee.tistory.com/entry/XCode-Swift-Command-Line-Tool-프로젝트에서-유닛-테스트-하기">이 글</a>을 참고해서 추가한다.</p>
</blockquote>

<p>웹에서 이미지를 가져온다거나, 대용량 데이터를 가져올 때에 보통 비동기로 메서드를 만들게 된다. 이렇게 만든 비동기 메서드를 테스트하는 방법을 알아보자.</p>

<p><code class="language-plaintext highlighter-rouge">create(_:completion:)</code>는 Core Data에 데이터를 저장하는 메서드다. completion 블록을 이용해 성공 여부와 에러를 함께 반환한다. <code class="language-plaintext highlighter-rouge">NSManagedObjectContext.perform(_:)</code>은 비동기로 동작한다.</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="n">_</span> <span class="nv">newPost</span><span class="p">:</span> <span class="kt">Post</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">context</span><span class="p">:</span> <span class="kt">NSManagedObjectContext</span> <span class="o">=</span> <span class="n">coreDataStack</span><span class="o">.</span><span class="n">mainContext</span>
    <span class="n">context</span><span class="o">.</span><span class="n">perform</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">post</span><span class="p">:</span> <span class="kt">PostEntity</span> <span class="o">=</span> <span class="n">newPost</span><span class="o">.</span><span class="nf">toEntity</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">try</span> <span class="n">context</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span>
            <span class="nf">completion</span><span class="p">(</span><span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nf">completion</span><span class="p">(</span><span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="o">.</span><span class="n">failedCreate</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>초기 테스트 코드는 다음과 같이 작성했었다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">test_Post를_하나_만들_수_있다</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// given: 필요한 모든 값 설정</span>
    <span class="k">let</span> <span class="nv">repository</span><span class="p">:</span> <span class="kt">Repository</span> <span class="o">=</span> <span class="kt">Repository</span><span class="p">()</span>
    <span class="k">let</span> <span class="nv">newPost</span><span class="p">:</span> <span class="kt">Post</span> <span class="o">=</span> <span class="kt">Post</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="s">"테스트 포스트"</span><span class="p">)</span>

    <span class="c1">// when: 테스트 중인 코드 실행</span>
    <span class="n">repository</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="n">newPost</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
            <span class="c1">// then: 예상한 결과 확인</span>
            <span class="n">repository</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="nv">withpermalink</span><span class="p">:</span> <span class="n">newPost</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span> <span class="p">{</span> <span class="n">getResult</span> <span class="k">in</span>
                <span class="k">switch</span> <span class="n">getResult</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">postEntity</span><span class="p">):</span>
                    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">postEntity</span><span class="o">.</span><span class="n">title</span> <span class="p">??</span> <span class="s">""</span><span class="p">,</span> <span class="n">newPost</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                    <span class="kt">XCTFail</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="kt">XCTFail</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>참고로 테스트 코드에 있는 <code class="language-plaintext highlighter-rouge">get(withpermalink:completion:)</code> 도 비동기 메서드다.</p>

<p>처음에 작성하고, 항상 성공하길래 내가 제대로 작성한 줄 알고 있었다. 이렇게 작성하고 코드 리뷰를 받고 나서 알게 된 사실이 있는데, <mark>테스트 코드는 비동기를 기다려주지 않는다.</mark> 그래서 항상 성공했던 거였다. 😂</p>

<p>테스트 코드가 비동기 메서드의 결과가 반환될 때까지 기다려주지 않는다면, 기다리게 만들자.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">XCTestCase</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">timeout</span><span class="p">(</span><span class="n">_</span> <span class="nv">timeout</span><span class="p">:</span> <span class="kt">TimeInterval</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">(</span><span class="kt">XCTestExpectation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">exp</span><span class="p">:</span> <span class="kt">XCTestExpectation</span> <span class="o">=</span> <span class="nf">expectation</span><span class="p">(</span><span class="nv">description</span><span class="p">:</span> <span class="s">"Timeout: </span><span class="se">\(</span><span class="n">timeout</span><span class="se">)</span><span class="s"> seconds"</span><span class="p">)</span>
        <span class="nf">completion</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

        <span class="nf">waitForExpectations</span><span class="p">(</span><span class="nv">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="kt">XCTFail</span><span class="p">(</span><span class="s">"Timeout error: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">XCTestCase</code>의 extension으로 만들어서 비동기 메서드를 테스트할 때 호출해서 사용한다. 이 코드는 같이 프로젝트 하시는 분이 알려주신 건데 무한한 감사의 말씀을 전합니다… 🙏</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">exp</span><span class="p">:</span> <span class="kt">XCTestExpectation</span> <span class="o">=</span> <span class="nf">expectation</span><span class="p">(</span><span class="nv">description</span><span class="p">:</span> <span class="s">"Timeout: </span><span class="se">\(</span><span class="n">timeout</span><span class="se">)</span><span class="s"> seconds"</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>Use this method to create XCTestExpectation instances that can be fulfilled when asynchronous tasks in your tests complete.</p>
</blockquote>

<blockquote>
  <p>이 메서드를 사용하여 테스트의 비동기 작업이 완료될 때 충족될 수 있는 XCTestExpectation 인스턴스를 만든다.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">description</code>에 들어가는 문자열은 시간 초과하면 출력될 문자열이다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">waitForExpectations</span><span class="p">(</span><span class="nv">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="kt">XCTFail</span><span class="p">(</span><span class="s">"Timeout error: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">waitForExpectations(timeout:handler:)</code>는 테스트가 모든 기대치를 충족하거나 시간이 초과할 때까지 기다린다. 여기서 말하는 기대치 충족이란 <code class="language-plaintext highlighter-rouge">XCTestExpectation.fulfill()</code> 메서드 호출을 뜻한다. 위의 코드를 다시 보면 <code class="language-plaintext highlighter-rouge">completion(exp)</code> 으로 외부에 반환하는데 비동기 메서드를 다 기다리고 나서 기대치 충족했다고 호출하기 위함이다.</p>

<p>이렇게 만든 <code class="language-plaintext highlighter-rouge">timeout(_:completion:)</code> 메서드를 비동기 메서드 테스트할 때 사용하면 되는데 항상 성공했던 망한 코드를 <code class="language-plaintext highlighter-rouge">timeout(_:completion:)</code> 메서드를 이용해서 수정하면 다음과 같다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">test_Post를_하나_만들_수_있다</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// given: 필요한 모든 값 설정</span>
    <span class="k">let</span> <span class="nv">repository</span><span class="p">:</span> <span class="kt">Repository</span> <span class="o">=</span> <span class="kt">Repository</span><span class="p">()</span>
    <span class="k">let</span> <span class="nv">newPost</span><span class="p">:</span> <span class="kt">Post</span> <span class="o">=</span> <span class="kt">Post</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="s">"테스트 포스트"</span><span class="p">)</span>

    <span class="c1">// when: 테스트 중인 코드 실행</span>
    <span class="nf">timeout</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="n">exp</span> <span class="k">in</span>
        <span class="n">repository</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="n">newPost</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
                <span class="c1">// then: 예상한 결과 확인</span>
                <span class="n">repository</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="nv">withpermalink</span><span class="p">:</span> <span class="n">newPost</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span> <span class="p">{</span> <span class="n">getResult</span> <span class="k">in</span>
                    <span class="n">exp</span><span class="o">.</span><span class="nf">fulfill</span><span class="p">()</span> <span class="c1">// ← 이 위치!</span>
                    <span class="k">switch</span> <span class="n">getResult</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">postEntity</span><span class="p">):</span>
                        <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">postEntity</span><span class="o">.</span><span class="n">title</span> <span class="p">??</span> <span class="s">""</span><span class="p">,</span> <span class="n">newPost</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                        <span class="kt">XCTFail</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                <span class="kt">XCTFail</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// exp.fulfill() 여기서 호출하면 ❌</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>여기서 주의해야 할 점은, <code class="language-plaintext highlighter-rouge">fulfill()</code> 를 호출하는 시점이 <code class="language-plaintext highlighter-rouge">create</code> 클로저가 끝난 후에 하면 안 되고 클로저 내부에서 호출해야 한다. 왜냐하면, 클로저가 끝나고 호출하게 되면 <code class="language-plaintext highlighter-rouge">create</code> 메서드가 비동기라서 끝나지 않았는데 끝났다고 처리된다. 게다가 이 코드는 비동기를 이중으로 호출하고 있으니, <code class="language-plaintext highlighter-rouge">create</code> 클로저 내부에 있는 <code class="language-plaintext highlighter-rouge">get</code> 클로저 안에서 호출해야 한다.</p>

<p>더불어 <code class="language-plaintext highlighter-rouge">fulfill()</code> 호출과 관계없이, 지정한 시간을 초과하게 되면 자연스레 테스트가 실패하게 된다.</p>

<h2 id="참고-자료">참고 자료</h2>

<ul>
  <li><a href="https://developer.apple.com/documentation/xctest/xctestexpectation">XCTestExpectation - Apple Developer Documentation</a></li>
  <li><a href="https://developer.apple.com/documentation/xctest/xctestexpectation/1501027-fulfill">fulfill() - Apple Developer Documentation</a></li>
  <li><a href="https://developer.apple.com/documentation/xctest/xctestcase/1500748-waitforexpectations">waitForExpectations(timeout:handler:) - Apple Developer Documentation</a></li>
</ul>

<h2 id="태그">태그</h2>

<p>#iOS/XCTests #비동기 #UnitTest</p>
