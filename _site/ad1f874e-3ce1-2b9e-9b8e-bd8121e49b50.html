<h1 id="xctest-ë¹„ë™ê¸°-ë©”ì„œë“œ-í…ŒìŠ¤íŠ¸í•˜ê¸°">[XCTest] ë¹„ë™ê¸° ë©”ì„œë“œ í…ŒìŠ¤íŠ¸í•˜ê¸°</h1>

<blockquote>
  <p>ì´ ê¸€ì—ì„œëŠ” ìœ ë‹› í…ŒìŠ¤íŠ¸í•˜ëŠ” ë²•ì€ ë‹¤ë£¨ì§€ ì•Šê³ , ë¹„ë™ê¸° ë©”ì„œë“œë¥¼ ì–´ë–»ê²Œ í…ŒìŠ¤íŠ¸í•˜ëŠ”ì§€ë§Œ ë‹¤ë£¬ë‹¤. í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•  ë•Œ ìœ ë‹› í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•˜ì§€ ì•Šì•˜ë‹¤ë©´ <a href="https://jwonylee.tistory.com/entry/XCode-Swift-Command-Line-Tool-í”„ë¡œì íŠ¸ì—ì„œ-ìœ ë‹›-í…ŒìŠ¤íŠ¸-í•˜ê¸°">ì´ ê¸€</a>ì„ ì°¸ê³ í•´ì„œ ì¶”ê°€í•œë‹¤.</p>
</blockquote>

<p>ì›¹ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¨ë‹¤ê±°ë‚˜, ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë•Œì— ë³´í†µ ë¹„ë™ê¸°ë¡œ ë©”ì„œë“œë¥¼ ë§Œë“¤ê²Œ ëœë‹¤. ì´ë ‡ê²Œ ë§Œë“  ë¹„ë™ê¸° ë©”ì„œë“œë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì.</p>

<p><code class="language-plaintext highlighter-rouge">create(_:completion:)</code>ëŠ” Core Dataì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë©”ì„œë“œë‹¤. completion ë¸”ë¡ì„ ì´ìš©í•´ ì„±ê³µ ì—¬ë¶€ì™€ ì—ëŸ¬ë¥¼ í•¨ê»˜ ë°˜í™˜í•œë‹¤. <code class="language-plaintext highlighter-rouge">NSManagedObjectContext.perform(_:)</code>ì€ ë¹„ë™ê¸°ë¡œ ë™ì‘í•œë‹¤.</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="n">_</span> <span class="nv">newPost</span><span class="p">:</span> <span class="kt">Post</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">context</span><span class="p">:</span> <span class="kt">NSManagedObjectContext</span> <span class="o">=</span> <span class="n">coreDataStack</span><span class="o">.</span><span class="n">mainContext</span>
    <span class="n">context</span><span class="o">.</span><span class="n">perform</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">post</span><span class="p">:</span> <span class="kt">PostEntity</span> <span class="o">=</span> <span class="n">newPost</span><span class="o">.</span><span class="nf">toEntity</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">try</span> <span class="n">context</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span>
            <span class="nf">completion</span><span class="p">(</span><span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nf">completion</span><span class="p">(</span><span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="o">.</span><span class="n">failedCreate</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì´ˆê¸° í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í–ˆì—ˆë‹¤.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">test_Postë¥¼_í•˜ë‚˜_ë§Œë“¤_ìˆ˜_ìˆë‹¤</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// given: í•„ìš”í•œ ëª¨ë“  ê°’ ì„¤ì •</span>
    <span class="k">let</span> <span class="nv">repository</span><span class="p">:</span> <span class="kt">Repository</span> <span class="o">=</span> <span class="kt">Repository</span><span class="p">()</span>
    <span class="k">let</span> <span class="nv">newPost</span><span class="p">:</span> <span class="kt">Post</span> <span class="o">=</span> <span class="kt">Post</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="s">"í…ŒìŠ¤íŠ¸ í¬ìŠ¤íŠ¸"</span><span class="p">)</span>

    <span class="c1">// when: í…ŒìŠ¤íŠ¸ ì¤‘ì¸ ì½”ë“œ ì‹¤í–‰</span>
    <span class="n">repository</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="n">newPost</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
            <span class="c1">// then: ì˜ˆìƒí•œ ê²°ê³¼ í™•ì¸</span>
            <span class="n">repository</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="nv">withpermalink</span><span class="p">:</span> <span class="n">newPost</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span> <span class="p">{</span> <span class="n">getResult</span> <span class="k">in</span>
                <span class="k">switch</span> <span class="n">getResult</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">postEntity</span><span class="p">):</span>
                    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">postEntity</span><span class="o">.</span><span class="n">title</span> <span class="p">??</span> <span class="s">""</span><span class="p">,</span> <span class="n">newPost</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                    <span class="kt">XCTFail</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="kt">XCTFail</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì°¸ê³ ë¡œ í…ŒìŠ¤íŠ¸ ì½”ë“œì— ìˆëŠ” <code class="language-plaintext highlighter-rouge">get(withpermalink:completion:)</code> ë„ ë¹„ë™ê¸° ë©”ì„œë“œë‹¤.</p>

<p>ì²˜ìŒì— ì‘ì„±í•˜ê³ , í•­ìƒ ì„±ê³µí•˜ê¸¸ë˜ ë‚´ê°€ ì œëŒ€ë¡œ ì‘ì„±í•œ ì¤„ ì•Œê³  ìˆì—ˆë‹¤. ì´ë ‡ê²Œ ì‘ì„±í•˜ê³  ì½”ë“œ ë¦¬ë·°ë¥¼ ë°›ê³  ë‚˜ì„œ ì•Œê²Œ ëœ ì‚¬ì‹¤ì´ ìˆëŠ”ë°, <mark>í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ë¹„ë™ê¸°ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì§€ ì•ŠëŠ”ë‹¤.</mark> ê·¸ë˜ì„œ í•­ìƒ ì„±ê³µí–ˆë˜ ê±°ì˜€ë‹¤. ğŸ˜‚</p>

<p>í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ë¹„ë™ê¸° ë©”ì„œë“œì˜ ê²°ê³¼ê°€ ë°˜í™˜ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì§€ ì•ŠëŠ”ë‹¤ë©´, ê¸°ë‹¤ë¦¬ê²Œ ë§Œë“¤ì.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">XCTestCase</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">timeout</span><span class="p">(</span><span class="n">_</span> <span class="nv">timeout</span><span class="p">:</span> <span class="kt">TimeInterval</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">(</span><span class="kt">XCTestExpectation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">exp</span><span class="p">:</span> <span class="kt">XCTestExpectation</span> <span class="o">=</span> <span class="nf">expectation</span><span class="p">(</span><span class="nv">description</span><span class="p">:</span> <span class="s">"Timeout: </span><span class="se">\(</span><span class="n">timeout</span><span class="se">)</span><span class="s"> seconds"</span><span class="p">)</span>
        <span class="nf">completion</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

        <span class="nf">waitForExpectations</span><span class="p">(</span><span class="nv">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="kt">XCTFail</span><span class="p">(</span><span class="s">"Timeout error: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">XCTestCase</code>ì˜ extensionìœ¼ë¡œ ë§Œë“¤ì–´ì„œ ë¹„ë™ê¸° ë©”ì„œë“œë¥¼ í…ŒìŠ¤íŠ¸í•  ë•Œ í˜¸ì¶œí•´ì„œ ì‚¬ìš©í•œë‹¤. ì´ ì½”ë“œëŠ” ê°™ì´ í”„ë¡œì íŠ¸ í•˜ì‹œëŠ” ë¶„ì´ ì•Œë ¤ì£¼ì‹  ê±´ë° ë¬´í•œí•œ ê°ì‚¬ì˜ ë§ì”€ì„ ì „í•©ë‹ˆë‹¤â€¦ ğŸ™</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">exp</span><span class="p">:</span> <span class="kt">XCTestExpectation</span> <span class="o">=</span> <span class="nf">expectation</span><span class="p">(</span><span class="nv">description</span><span class="p">:</span> <span class="s">"Timeout: </span><span class="se">\(</span><span class="n">timeout</span><span class="se">)</span><span class="s"> seconds"</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>Use this method to create XCTestExpectation instances that can be fulfilled when asynchronous tasks in your tests complete.</p>
</blockquote>

<blockquote>
  <p>ì´ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ì˜ ë¹„ë™ê¸° ì‘ì—…ì´ ì™„ë£Œë  ë•Œ ì¶©ì¡±ë  ìˆ˜ ìˆëŠ” XCTestExpectation ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“ ë‹¤.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">description</code>ì— ë“¤ì–´ê°€ëŠ” ë¬¸ìì—´ì€ ì‹œê°„ ì´ˆê³¼í•˜ë©´ ì¶œë ¥ë  ë¬¸ìì—´ì´ë‹¤.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">waitForExpectations</span><span class="p">(</span><span class="nv">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="kt">XCTFail</span><span class="p">(</span><span class="s">"Timeout error: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">waitForExpectations(timeout:handler:)</code>ëŠ” í…ŒìŠ¤íŠ¸ê°€ ëª¨ë“  ê¸°ëŒ€ì¹˜ë¥¼ ì¶©ì¡±í•˜ê±°ë‚˜ ì‹œê°„ì´ ì´ˆê³¼í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤. ì—¬ê¸°ì„œ ë§í•˜ëŠ” ê¸°ëŒ€ì¹˜ ì¶©ì¡±ì´ë€ <code class="language-plaintext highlighter-rouge">XCTestExpectation.fulfill()</code> ë©”ì„œë“œ í˜¸ì¶œì„ ëœ»í•œë‹¤. ìœ„ì˜ ì½”ë“œë¥¼ ë‹¤ì‹œ ë³´ë©´ <code class="language-plaintext highlighter-rouge">completion(exp)</code> ìœ¼ë¡œ ì™¸ë¶€ì— ë°˜í™˜í•˜ëŠ”ë° ë¹„ë™ê¸° ë©”ì„œë“œë¥¼ ë‹¤ ê¸°ë‹¤ë¦¬ê³  ë‚˜ì„œ ê¸°ëŒ€ì¹˜ ì¶©ì¡±í–ˆë‹¤ê³  í˜¸ì¶œí•˜ê¸° ìœ„í•¨ì´ë‹¤.</p>

<p>ì´ë ‡ê²Œ ë§Œë“  <code class="language-plaintext highlighter-rouge">timeout(_:completion:)</code> ë©”ì„œë“œë¥¼ ë¹„ë™ê¸° ë©”ì„œë“œ í…ŒìŠ¤íŠ¸í•  ë•Œ ì‚¬ìš©í•˜ë©´ ë˜ëŠ”ë° í•­ìƒ ì„±ê³µí–ˆë˜ ë§í•œ ì½”ë“œë¥¼ <code class="language-plaintext highlighter-rouge">timeout(_:completion:)</code> ë©”ì„œë“œë¥¼ ì´ìš©í•´ì„œ ìˆ˜ì •í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">test_Postë¥¼_í•˜ë‚˜_ë§Œë“¤_ìˆ˜_ìˆë‹¤</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// given: í•„ìš”í•œ ëª¨ë“  ê°’ ì„¤ì •</span>
    <span class="k">let</span> <span class="nv">repository</span><span class="p">:</span> <span class="kt">Repository</span> <span class="o">=</span> <span class="kt">Repository</span><span class="p">()</span>
    <span class="k">let</span> <span class="nv">newPost</span><span class="p">:</span> <span class="kt">Post</span> <span class="o">=</span> <span class="kt">Post</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="s">"í…ŒìŠ¤íŠ¸ í¬ìŠ¤íŠ¸"</span><span class="p">)</span>

    <span class="c1">// when: í…ŒìŠ¤íŠ¸ ì¤‘ì¸ ì½”ë“œ ì‹¤í–‰</span>
    <span class="nf">timeout</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="n">exp</span> <span class="k">in</span>
        <span class="n">repository</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="n">newPost</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
                <span class="c1">// then: ì˜ˆìƒí•œ ê²°ê³¼ í™•ì¸</span>
                <span class="n">repository</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="nv">withpermalink</span><span class="p">:</span> <span class="n">newPost</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span> <span class="p">{</span> <span class="n">getResult</span> <span class="k">in</span>
                    <span class="n">exp</span><span class="o">.</span><span class="nf">fulfill</span><span class="p">()</span> <span class="c1">// â† ì´ ìœ„ì¹˜!</span>
                    <span class="k">switch</span> <span class="n">getResult</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">postEntity</span><span class="p">):</span>
                        <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">postEntity</span><span class="o">.</span><span class="n">title</span> <span class="p">??</span> <span class="s">""</span><span class="p">,</span> <span class="n">newPost</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                        <span class="kt">XCTFail</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
                <span class="kt">XCTFail</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// exp.fulfill() ì—¬ê¸°ì„œ í˜¸ì¶œí•˜ë©´ âŒ</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ ì£¼ì˜í•´ì•¼ í•  ì ì€, <code class="language-plaintext highlighter-rouge">fulfill()</code> ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ì´ <code class="language-plaintext highlighter-rouge">create</code> í´ë¡œì €ê°€ ëë‚œ í›„ì— í•˜ë©´ ì•ˆ ë˜ê³  í´ë¡œì € ë‚´ë¶€ì—ì„œ í˜¸ì¶œí•´ì•¼ í•œë‹¤. ì™œëƒí•˜ë©´, í´ë¡œì €ê°€ ëë‚˜ê³  í˜¸ì¶œí•˜ê²Œ ë˜ë©´ <code class="language-plaintext highlighter-rouge">create</code> ë©”ì„œë“œê°€ ë¹„ë™ê¸°ë¼ì„œ ëë‚˜ì§€ ì•Šì•˜ëŠ”ë° ëë‚¬ë‹¤ê³  ì²˜ë¦¬ëœë‹¤. ê²Œë‹¤ê°€ ì´ ì½”ë“œëŠ” ë¹„ë™ê¸°ë¥¼ ì´ì¤‘ìœ¼ë¡œ í˜¸ì¶œí•˜ê³  ìˆìœ¼ë‹ˆ, <code class="language-plaintext highlighter-rouge">create</code> í´ë¡œì € ë‚´ë¶€ì— ìˆëŠ” <code class="language-plaintext highlighter-rouge">get</code> í´ë¡œì € ì•ˆì—ì„œ í˜¸ì¶œí•´ì•¼ í•œë‹¤.</p>

<p>ë”ë¶ˆì–´ <code class="language-plaintext highlighter-rouge">fulfill()</code> í˜¸ì¶œê³¼ ê´€ê³„ì—†ì´, ì§€ì •í•œ ì‹œê°„ì„ ì´ˆê³¼í•˜ê²Œ ë˜ë©´ ìì—°ìŠ¤ë ˆ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ê²Œ ëœë‹¤.</p>

<h2 id="ì°¸ê³ -ìë£Œ">ì°¸ê³  ìë£Œ</h2>

<ul>
  <li><a href="https://developer.apple.com/documentation/xctest/xctestexpectation">XCTestExpectation - Apple Developer Documentation</a></li>
  <li><a href="https://developer.apple.com/documentation/xctest/xctestexpectation/1501027-fulfill">fulfill() - Apple Developer Documentation</a></li>
  <li><a href="https://developer.apple.com/documentation/xctest/xctestcase/1500748-waitforexpectations">waitForExpectations(timeout:handler:) - Apple Developer Documentation</a></li>
</ul>

<h2 id="íƒœê·¸">íƒœê·¸</h2>

<p>#iOS/XCTests #ë¹„ë™ê¸° #UnitTest</p>
